#!/usr/bin/env bash
set -euo pipefail

# ------------------------------------------------------------------------------
# Everest Manager - Minecraft Server Management CLI
# ------------------------------------------------------------------------------

# Paths
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_PATH="$(realpath "${SCRIPT_DIR}/..")"

CONFIG_FILE="${ROOT_PATH}/config/instances.json"
ENGINE_DIR="${ROOT_PATH}/libraries/engines"
UTILS_DIR="${ROOT_PATH}/bin/utils"

# Commands
ACTION="${1:-help}"
SERVER_NAME="${2:-}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ------------------------------------------------------------------------------
# Helper Functions
# ------------------------------------------------------------------------------

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_err() { echo -e "${RED}[ERROR]${NC} $1" >&2; }
log_step() { echo -e "${BLUE}[STEP]${NC} $1"; }

check_deps() {
    # Check for required dependenciesÆ’
    for cmd in tmux java jq realpath curl sed grep sort tail mv mktemp; do
        command -v "$cmd" &>/dev/null || {
            log_err "'$cmd' is required but not installed."
            exit 1
        }
    done
}

load_env() {
    if [[ -f "${ROOT_PATH}/.env" ]]; then
        export $(grep -v '^#' "${ROOT_PATH}/.env" | xargs)
    fi
}

get_config() {
    local key="$1"
    jq -r ".instances[\"${SERVER_NAME}\"].${key} // empty" "$CONFIG_FILE"
}

# ------------------------------------------------------------------------------
# Action: Update
# ------------------------------------------------------------------------------
cmd_update() {
    log_info "Starting Everest Update Process..."

    echo "" # Spacer

    # 1. Config Check
    for config_file in instances.json update.json; do
        if [[ ! -f "${ROOT_PATH}/config/${config_file}" ]]; then
            log_err "Configuration file missing: config/${config_file}"
            exit 1
        fi
    done

    # 2. Check Utils Existence
    if [[ ! -d "$UTILS_DIR" ]]; then
        log_err "Utils directory not found at: $UTILS_DIR"
        exit 1
    fi

    # 3. Execute Downloader Scripts
    log_step "Downloading Engines..."
    if ! bash "${UTILS_DIR}/get-engine.sh"; then
        log_err "Engine download failed."
        exit 1
    fi

    echo "" # Spacer

    log_step "Downloading Plugins..."
    if ! bash "${UTILS_DIR}/get-plugin.sh"; then
        log_err "Plugin download failed."
        exit 1
    fi

    echo "" # Spacer

    # 4. Execute Linker Scripts
    log_step "Linking Libraries..."
    if ! bash "${UTILS_DIR}/link-library.sh"; then
        log_err "Library linking failed."
        exit 1
    fi

    echo "" # Spacer

    log_step "Linking Plugins to Servers..."
    if ! bash "${UTILS_DIR}/link-plugin.sh"; then
        log_err "Plugin linking failed."
        exit 1
    fi

    echo "" # Spacer

    log_info "Update process completed successfully!"
    log_info "You may need to restart servers to apply changes: '$0 restart <server>'"
}

# ------------------------------------------------------------------------------
# Action: Start
# ------------------------------------------------------------------------------
cmd_start() {
    if [[ -z "$SERVER_NAME" ]]; then
        log_err "Usage: $0 start <server-name>"
        exit 1
    fi

    if [[ ! -f "$CONFIG_FILE" ]]; then
        log_err "Config file not found: $CONFIG_FILE"
        exit 1
    fi

    local ENGINE_TYPE=$(get_config "engine")
    local MEM_MIN=$(get_config "memory.min")
    local MEM_MAX=$(get_config "memory.max")

    if [[ -z "$ENGINE_TYPE" ]]; then
        log_err "Server '$SERVER_NAME' not found in config."
        exit 1
    fi

    local SERVER_DIR="${ROOT_PATH}/instances/${SERVER_NAME}"
    if [[ ! -d "$SERVER_DIR" ]]; then
        log_err "Instance directory not found: $SERVER_DIR"
        exit 1
    fi

    local JAR_FILE=$(find "$ENGINE_DIR" -maxdepth 1 -type f -name "${ENGINE_TYPE}*.jar" | sort -V | tail -n1)
    if [[ -z "$JAR_FILE" ]]; then
        log_err "Engine jar for '$ENGINE_TYPE' not found in $ENGINE_DIR"
        exit 1
    fi

    # Base Flags
    local JAVA_FLAGS=(
        "-Xms${MEM_MIN}"
        "-Xmx${MEM_MAX}"
        "-XX:+UseG1GC"
        "-XX:+ParallelRefProcEnabled"
        "-XX:MaxGCPauseMillis=200"
        "-XX:+UnlockExperimentalVMOptions"
        "-XX:+DisableExplicitGC"
        "-XX:+AlwaysPreTouch"
        "-XX:G1NewSizePercent=30"
        "-XX:G1MaxNewSizePercent=40"
        "-XX:G1HeapRegionSize=8M"
        "-XX:G1ReservePercent=20"
        "-XX:G1HeapWastePercent=5"
        "-XX:G1MixedGCCountTarget=4"
        "-XX:InitiatingHeapOccupancyPercent=15"
        "-XX:G1MixedGCLiveThresholdPercent=90"
        "-XX:G1RSetUpdatingPauseTimePercent=5"
        "-XX:SurvivorRatio=32"
        "-XX:+PerfDisableSharedMem"
        "-XX:MaxTenuringThreshold=1"
        "-Dusing.aikars.flags=https://mcflags.emc.gs"
        "-Daikars.new.flags=true"
    )

    if [[ "$ENGINE_TYPE" == "velocity" ]]; then
        JAVA_FLAGS=(
            "-Xms${MEM_MIN}"
            "-Xmx${MEM_MAX}"
            "-XX:+UseG1GC"
            "-XX:G1HeapRegionSize=4M"
            "-XX:+UnlockExperimentalVMOptions"
            "-XX:+ParallelRefProcEnabled"
            "-XX:+AlwaysPreTouch"
            "-XX:MaxInlineLevel=15"
        )
    fi

    readarray -t EXTRA_FLAGS < <(jq -r ".instances[\"${SERVER_NAME}\"].java_flags[]? // empty" "$CONFIG_FILE")
    JAVA_FLAGS+=("${EXTRA_FLAGS[@]}")

    local TMUX_SESSION="${SERVER_NAME}"
    local START_CMD="
        cd \"${SERVER_DIR}\";
        while true; do
            echo \"[$(date '+%H:%M:%S') INFO] [Everest]: Starting ${SERVER_NAME} with ${ENGINE_TYPE}...\";
            java ${JAVA_FLAGS[*]} -jar \"${JAR_FILE}\" nogui;
            echo \"[$(date '+%H:%M:%S') WARN] [Everest]: Server stopped. Restarting in 3 seconds... (Press Ctrl+C to cancel)\";
            sleep 3;
        done
    "

    if tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
        log_warn "Session '$TMUX_SESSION' already exists. Attaching..."
        tmux attach -t "$TMUX_SESSION"
    else
        log_info "Creating new session for '$SERVER_NAME'..."
        tmux new-session -s "$TMUX_SESSION" -d "bash -c '${START_CMD}'"
        log_info "Server started! Use '$0 attach $SERVER_NAME' to view console."
    fi
}

# ------------------------------------------------------------------------------
# Action: Stop / Attach / List
# ------------------------------------------------------------------------------
cmd_stop() {
    if [[ -z "$SERVER_NAME" ]]; then
        log_err "Usage: $0 stop <server-name>"
        exit 1
    fi
    if tmux has-session -t "$SERVER_NAME" 2>/dev/null; then
        log_info "Sending stop command to '$SERVER_NAME'..."
        tmux send-keys -t "$SERVER_NAME" "stop" C-m "end" C-m
        log_info "Stop signal sent."
    else
        log_warn "No running session found for '$SERVER_NAME'."
    fi
}

cmd_attach() {
    if [[ -z "$SERVER_NAME" ]]; then
        log_err "Usage: $0 attach <server-name>"
        exit 1
    fi
    if tmux has-session -t "$SERVER_NAME" 2>/dev/null; then
        tmux attach -t "$SERVER_NAME"
    else
        log_err "No session found for '$SERVER_NAME'."
    fi
}

# ------------------------------------------------------------------------------
# Main Switch
# ------------------------------------------------------------------------------
check_deps
load_env

case "$ACTION" in
start) cmd_start ;;
stop) cmd_stop ;;
attach) cmd_attach ;;
restart)
    cmd_stop
    sleep 5
    cmd_start
    ;;
update) cmd_update ;;
list)
    jq -r '.instances | keys[]' "$CONFIG_FILE"
    echo "--- Active Sessions ---"
    tmux list-sessions 2>/dev/null || echo "No active sessions."
    ;;
*)
    echo "Usage: $0 {start|stop|restart|attach|update|list} [server-name]"
    exit 1
    ;;
esac
