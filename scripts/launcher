#!/usr/bin/env bash
set -euo pipefail

# ------------------------------------------------------------------------------
# Everest Launcher - Generic Minecraft Server Launcher
# ------------------------------------------------------------------------------
# Launches a specified Minecraft server inside a tmux session,
# automatically restarting it if it crashes.
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# Arguments
# ------------------------------------------------------------------------------

# Define arguments
SERVER_NAME="${1:-}"
ENGINE_TYPE="${2:-paper}"
EXTRA_JAVA_FLAGS=("${@:3}")

# Session name for tmux
TMUX_SESSION="${SERVER_NAME}"

# ------------------------------------------------------------------------------
# Configuration
# ------------------------------------------------------------------------------

# Setting up our paths relative to the script's location.
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_PATH="$(realpath "${SCRIPT_DIR}/..")"

# For easier access later
SERVER_DIR="${ROOT_PATH}/servers/${SERVER_NAME}"
ENGINE_DIR="${ROOT_PATH}/libraries/engines"
CONFIG_FILE="${ROOT_PATH}/config/server.json"

# shellcheck disable=SC1091
source "${SCRIPT_DIR}/modules/library"

# shellcheck disable=SC2034
LOG_TAG="launcher"

# ------------------------------------------------------------------------------
# Pre-flight Checks
# ------------------------------------------------------------------------------

# Validate arguments
if [[ -z "$SERVER_NAME" ]]; then
    log_err "Usage: $0 <server-name> [engine-type] [java flags...]"
    exit 1
fi

# Check for required dependencies
check_deps tmux java realpath jq

# ------------------------------------------------------------------------------
# Main Process Logic
# ------------------------------------------------------------------------------

# Load environment variables
ENV_EXPORTS=()
if [[ -f "${ROOT_PATH}/.env" ]]; then
    while IFS='=' read -r key val; do
        [[ "$key" =~ ^#.*$ || -z "$key" ]] && continue
        ENV_EXPORTS+=("$key=$val")
        export "$key=$val"
    done <"${ROOT_PATH}/.env"
fi

# Enter server directory
cd "$SERVER_DIR" || {
    log_err "Failed to enter '$SERVER_DIR'"
    exit 1
}

# Find latest engine JAR (version-aware sort)
JAR_FILE=$(find "$ENGINE_DIR" -maxdepth 1 -type f -name "${ENGINE_TYPE}*.jar" | sort -V | tail -n1)
if [[ -z "$JAR_FILE" || ! -f "$JAR_FILE" ]]; then
    log_err "Engine not found for: '$ENGINE_TYPE'"
    exit 1
fi

# Load JVM flags from config/server.json definitions
mapfile -t COMMON_FLAGS < <(jq -r '.definitions.jvm_options.common[]' "$CONFIG_FILE")

ENGINE_FLAGS=()
if jq -e --arg e "$ENGINE_TYPE" '.definitions.jvm_options[$e]' "$CONFIG_FILE" >/dev/null 2>&1; then
    mapfile -t ENGINE_FLAGS < <(jq -r --arg e "$ENGINE_TYPE" '.definitions.jvm_options[$e][]' "$CONFIG_FILE")
else
    log_warn "No JVM options defined for engine '$ENGINE_TYPE' in config."
fi

# Build the full Java command as an array (safe from injection)
JAVA_CMD=(java "${COMMON_FLAGS[@]}" "${ENGINE_FLAGS[@]}" "${EXTRA_JAVA_FLAGS[@]}" -jar "$JAR_FILE" nogui)

# Write a restart wrapper script that tmux will execute
WRAPPER_SCRIPT=$(
    cat <<'WRAPPER_EOF'
while true; do
    echo "[$(date '+%H:%M:%S') INFO]: [launcher] Starting server..."
    "$@"
    echo "[$(date '+%H:%M:%S') WARN]: [launcher] Server stopped at $(date), restarting in 3 seconds..."
    sleep 3
done
WRAPPER_EOF
)

# Command to start the server with automatic restart
# Uses bash -c '...' _ args... pattern to pass arguments safely
START_CMD=(
    bash -c "$WRAPPER_SCRIPT" _ env "${ENV_EXPORTS[@]}" "${JAVA_CMD[@]}"
)

# Wrapper of tmux session
if tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
    log_warn "Tmux session '$TMUX_SESSION' already exists."

    # Check if server process is alive
    if ! pgrep -f "[j]ava.*$(basename "$JAR_FILE")" >/dev/null; then
        log_warn "Session alive, but server is down. Restarting..."
        tmux send-keys -t "$TMUX_SESSION" "stop" C-m
        sleep 8

        tmux kill-session -t "$TMUX_SESSION"
        tmux new-session -s "$TMUX_SESSION" -d -- "${START_CMD[@]}"

        log_info "Restarted server at $(date)"
    else
        log_warn "Server is already running."
    fi
else
    # Create new detached tmux session
    tmux new-session -s "$TMUX_SESSION" -d -- "${START_CMD[@]}"

    log_info "Server '$SERVER_NAME' is now running in tmux session '$TMUX_SESSION'."
fi

log_info "Attach to the session using: tmux attach -t $TMUX_SESSION"
exit 0
