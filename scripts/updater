#!/usr/bin/env bash
set -euo pipefail

# ------------------------------------------------------------------------------
# Everest - Updater
# ------------------------------------------------------------------------------
# Downloads and links the latest engines, plugins, and libraries as defined
# in config/update.json and config/server.json.
#
# Environment:
#   EVEREST_BRANCH  - Branch name to use (default: from config's defaultBranch)
# ------------------------------------------------------------------------------

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_PATH="$(realpath "${SCRIPT_DIR}/../")"

UPDATER_PATH="${SCRIPT_DIR}/core/update"

# shellcheck disable=SC1091
source "${SCRIPT_DIR}/core/library"

# shellcheck disable=SC2034
LOG_TAG="updater"

# Pre-flight
log_info "Checking for required tools..."

for cmd in jq realpath ln rm find sort tail mv mktemp curl grep sed head; do
    if ! command -v "$cmd" >/dev/null; then
        log_err "Missing dependency: '$cmd'. Please install it first."
        exit 1
    fi
done

for config_file in "${ROOT_PATH}/config/server.json" "${ROOT_PATH}/config/update.json"; do
    if [[ ! -f "${config_file}" ]]; then
        log_err "File '${config_file}' not found."
        exit 1
    fi
done

if [[ ! -d "$UPDATER_PATH" ]]; then
    log_err "Update script directory not found at: $UPDATER_PATH"
    exit 1
fi

# Export branch for child scripts
export EVEREST_BRANCH="${EVEREST_BRANCH:-}"

if [[ -n "$EVEREST_BRANCH" ]]; then
    log_info "Using branch: ${EVEREST_BRANCH}"
fi

# Main
failed_processes=()
fail_count=0

log_info "Starting download process..."

if ! bash "$UPDATER_PATH/get-engine.sh"; then
    log_err "Engine download failed."
    ((fail_count++)) || true
    failed_processes+=("get-engine")
fi

if ! bash "$UPDATER_PATH/get-plugin.sh"; then
    log_err "Plugin download failed."
    ((fail_count++)) || true
    failed_processes+=("get-plugin")
fi

log_info "Starting linking process..."

if ! bash "$UPDATER_PATH/link-library.sh"; then
    log_err "Mount linking failed."
    ((fail_count++)) || true
    failed_processes+=("link-mount")
fi

if ! bash "$UPDATER_PATH/link-plugin.sh"; then
    log_err "Plugin linking failed."
    ((fail_count++)) || true
    failed_processes+=("link-plugin")
fi

# Report
if [[ $fail_count -gt 0 ]]; then
    log_err "$fail_count process(es) failed: ${failed_processes[*]}"
else
    log_info "All processes completed successfully."
    log_info "Restart servers to apply changes."
fi

exit $fail_count
