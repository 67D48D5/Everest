#!/usr/bin/env bash
set -euo pipefail

# ------------------------------------------------------------------------------
# Everest - Updater
# ------------------------------------------------------------------------------
# Downloads and links the latest engines, plugins, and libraries as defined
# in config/update.json and config/server.json.
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# Configuration
# ------------------------------------------------------------------------------

# Setting up our paths relative to the script's location.
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)/utils"
ROOT_PATH="$(realpath "${SCRIPT_DIR}/../..")"
UTILS_DIR="${ROOT_PATH}/scripts/utils"

# For easier access later
SERVER_CONFIG_FILE="${ROOT_PATH}/config/server.json"
SOURCE_CONFIG_FILE="${ROOT_PATH}/config/update.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ------------------------------------------------------------------------------
# Helper Functions
# ------------------------------------------------------------------------------

# Logging helper functions
log_info() { echo -e "[$(date '+%H:%M:%S') ${GREEN}INFO${NC}] [updater]: $1"; }
log_warn() { echo -e "[$(date '+%H:%M:%S') ${YELLOW}WARN${NC}] [updater]: $1"; }
log_err() { echo -e "[$(date '+%H:%M:%S') ${RED}ERROR${NC}] [updater]: $1" >&2; }

# ------------------------------------------------------------------------------
# Pre-flight Checks
# ------------------------------------------------------------------------------

# Make sure we have the tools we need.
log_info "Checking for required tools..."
for cmd in jq realpath ln rm find sort tail mv mktemp curl grep sed head; do
    if ! command -v "$cmd" >/dev/null; then
        log_err "Missing dependency: '$cmd'. Please install it first."
        exit 1
    fi
done

# Ensure required config files exist.
for config_file in "${SERVER_CONFIG_FILE}" "${SOURCE_CONFIG_FILE}"; do
    if [[ ! -f "${config_file}" ]]; then
        log_err "File '${config_file}' not found. Please ensure it exists."
        exit 1
    fi
done

# Check Utils Existence
if [[ ! -d "$UTILS_DIR" ]]; then
    log_err "Utils directory not found at: $UTILS_DIR"
    exit 1
fi

# ------------------------------------------------------------------------------
# Main Process Logic
# ------------------------------------------------------------------------------

log_info "Starting downloading process..."

# Let's keep track of any failures
failed_processes=()
fail_count=0

# Execute download scripts and check their exit status
if ! bash "$SCRIPT_DIR/get-engine.sh"; then
    log_err "Engine download failed."
    fail_count=$((fail_count + 1))
    failed_processes+=("get-engine")
fi

if ! bash "$SCRIPT_DIR/get-plugin.sh"; then
    log_err "Plugin download failed."
    fail_count=$((fail_count + 1))
    failed_processes+=("get-plugin")
fi

log_info "Starting linking process..."
# Execute linking scripts and check their exit status
if ! bash "$SCRIPT_DIR/link-library.sh"; then
    log_err "Library linking failed."
    fail_count=$((fail_count + 1))
    failed_processes+=("link-library")
fi

if ! bash "$SCRIPT_DIR/link-plugin.sh"; then
    log_err "Plugin linking failed."
    fail_count=$((fail_count + 1))
    failed_processes+=("link-plugin")
fi

# Final status report
if [[ $fail_count -gt 0 ]]; then
    log_err "$fail_count process(es) failed during the update."
else
    log_info "All processes completed successfully."
    log_info "You may need to restart servers to apply changes."
fi

exit $fail_count
